name: Update Project Version

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Project version (example: 1.0.2 or 1.0.2.0)"
        required: true

jobs:
  update-version:
    runs-on: windows-latest
    permissions:
      contents: write

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    # 1️⃣ Generate update.json
    - name: Generate update.json
      shell: pwsh
      run: |
        $version = "${{ github.event.inputs.version }}"

        $json = @{
            version = $version
            url     = "https://github.com/MrPcGamerYT/Optimizer/releases/latest/download/OptimizerSetup.exe"
        } | ConvertTo-Json -Compress

        $json | Set-Content -Path update.json -Encoding UTF8
        Write-Host "Generated update.json: $json"

    # 2️⃣ Update AssemblyInfo.cs
    - name: Update AssemblyInfo.cs
      shell: powershell
      run: |
        $version = "${{ github.event.inputs.version }}"

        $file = Get-ChildItem -Recurse -Filter "AssemblyInfo.cs" -File | Select-Object -First 1

        if (-not $file) {
          Write-Error "AssemblyInfo.cs not found!"
          exit 1
        }

        Write-Host "Found AssemblyInfo.cs at $($file.FullName)"

        (Get-Content $file.FullName) `
          -replace '\[assembly:\s*AssemblyVersion\(".*?"\)\]', "[assembly: AssemblyVersion(`"$version`")]" `
          -replace '\[assembly:\s*AssemblyFileVersion\(".*?"\)\]', "[assembly: AssemblyFileVersion(`"$version`")]" |
        Set-Content $file.FullName -Encoding UTF8

        Write-Host "Updated AssemblyInfo.cs to version $version"

    # 3️⃣ Update installer.iss
    - name: Update installer.iss
      shell: powershell
      run: |
        $version = "${{ github.event.inputs.version }}"

        $file = Get-ChildItem -Recurse -Filter "installer.iss" -File | Select-Object -First 1

        if (-not $file) {
          Write-Error "installer.iss not found!"
          exit 1
        }

        Write-Host "Found installer.iss at $($file.FullName)"

        (Get-Content $file.FullName) `
          -replace '^AppVersion\s*=.*', "AppVersion=$version" `
          -replace '^VersionInfoVersion\s*=.*', "VersionInfoVersion=$version" |
        Set-Content $file.FullName -Encoding UTF8

        Write-Host "Updated installer.iss to version $version"

    # 4️⃣ Commit all changes
    - name: Commit version updates
      shell: pwsh
      run: |
        git config user.name "github-actions"
        git config user.email "github-actions@github.com"
        git add .
        git commit -m "Update project version to ${{ github.event.inputs.version }}" || echo "No changes to commit"
        git push
